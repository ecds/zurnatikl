{% extends 'network/graph_base.html' %}
{% load static %}
{# display all contributors to all journals #}

{% block javascript %}
    {{ block.super }}
    <script src="{% static 'js/sigma/plugins/sigma.statistics.louvain.min.js' %}"></script>
{% endblock %}

{% block pregraph-content %}
<ol class="breadcrumb">
  <li><a href="{% url 'journals:list' %}">Journals</a></li>
  <li class="active">Contributor Network</li>
</ol>

{% url 'journals:contributor-network-export' 'gexf' as gexf_url %}
{% url 'journals:contributor-network-export' 'graphml' as graphml_url %}
{% include 'network/snippets/download_graph.html' %}
<div id="control-pane">
    <h2 class="underline">filters</h2>

    <div>
      <h3>min degree <span id="min-degree-val">0</span></h3>
      0 <input id="min-degree" type="range" min="0" max="0" value="0"> <span id="max-degree-value">0</span><br>
    </div>
    <div>
      <h3>node category</h3>
      <select id="node-category">
        <option value="" selected>All categories</option>
      </select>
    </div>
    <span class="line"></span>
    <div>
      <button id="reset-btn">Reset filters</button>
      <button id="export-btn">Export</button>
    </div>
    <div id="dump" class="hidden"></div>
  </div>
{% endblock %}

{% block graph-init %}
<script>
var s = init_sigma_graph({
  json_url: "{% url 'journals:contributor-network-json' %}",
  sigma: {
      labelThreshold: 10,
      drawEdgeLabels: false,  {# graph is too large for edge labels, unless we can customize by zoom level #}
  },
  forceLink:  {
      autoStop: true,
      maxIterations: 100,
      iterationsPerRender: 10,
      barnesHutOptimize: true,
  },
  styles: {
      nodes: {
        size: {
          min: 0.5,
        }
      }
    }
});


// community detection should happen either on graph:layout_complete or
// graph:design_applied, because otherwise design colors override
// community colors
$('#graph-container').on('graph:design_applied', function() {
    // NOTE: could include in status, but community detection is
    // so fast that it doesn't actually show up, so it isn't helpful

    // community detection via louvain plugins
    console.log('Starting louvain community detection');
    var louvain = sigma.plugins.louvain(s.graph);
    console.log('# of partitions = ' + louvain.countPartitions(louvain.getPartitions()));

    // placeholder colors for now
    var colors = ["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"];
    // network colors from resonance
    var colors = ["#004052", "#996628", "#e5c951",
      "#bc1626", "#0aa3aa", "#d84f05",
      "#11203d" ,"#872675", "#577469",
      "#0c7549", "#28236b", "#de03a7",
      "#a2d23a", "#ffa700"];

    // TODO: set edges to use source node color (? or gray?)

    // color nodes based on their community
    s.graph.nodes().forEach(function(node) {
      // by default, assigned community number is set to _louvain
      node.color = colors[node._louvain];
    });
    // refresh sigma renderers
    s.refresh({skipIndexation: true});
});

// $('.move-icon').bind('click keypress',function(event) {
//       var newPos = s.position();
//       switch ($(this).attr('action')) {
//         case 'up':
//           newPos.stageY += moveDelay;
//           break;
//         case 'down':
//           newPos.stageY -= moveDelay;
//           break;
//         case 'left':
//           newPos.stageX += moveDelay;
//           break;
//         case 'right':
//           newPos.stageX -= moveDelay;
//           break;
//       }

//       s.goTo(newPos.stageX, newPos.stageY);

//       event.stopPropagation();
//       return false;
//     });

//     $('.zoom-icon').bind('click keypress',function(event) {
//       var ratio = s.position().ratio;
//       switch ($(this).attr('action')) {
//         case 'in':
//           ratio *= zoomDelay;
//           break;
//         case 'out':
//           ratio /= zoomDelay;
//           break;
//       }

//       s.goTo(
//         $('#graph-container').width() / 2,
//         $('#graph-container').height() / 2,
//         ratio
//       );

//       event.stopPropagation();
//       return false;
//     });

//     $('.refresh-icon').bind('click keypress',function(event) {
//       s.position(0, 0, 1).draw();

//       event.stopPropagation();
//       return false;
//     });
</script>
{% endblock %}

